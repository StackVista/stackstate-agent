stages:
  - build_runner_base
  - build_runners

variables:
  RUNNER7_DEB_BASE: $CI_PROJECT_DIR/.cd-builders/runner7-circle-deb
  RUNNER7_MAIN: $CI_PROJECT_DIR/.cd-builders/runner7-gitlab-deb
  DOCKER_REGISTRY: quay.io
  QUAY_REGISTRY: quay.io

before_script:
  - docker login -u "${docker_user}" -p "${docker_password}" "${DOCKER_REGISTRY}"
  - docker login -u "${quay_user}" -p "${quay_password}" "${QUAY_REGISTRY}"

.docker_build_base: &docker_build_base
  # use docker as the image builder
  image: artifactory.tooling.stackstate.io/docker-virtual/docker:18.06.0
  variables:
    DOCKER_DRIVER: overlay
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  services:
    - name: artifactory.tooling.stackstate.io/docker-virtual/docker:18.09-dind
      alias: docker

# produces the base deb image: quay.io/stackstate/stackstate-agent-runner-circle:deb7_{yyyymmdd}
build-deb-base:
  <<: *docker_build_base
  stage: build_runner_base
  script:
    - cd $RUNNER7_DEB_BASE
    # get the current date as the base image version
    - BASE_RUNNER_IMAGE_VERSION="deb7_$(date +%Y%m%d)"
    # make the image, push the tag to quay
    - docker build -t $DOCKER_REPOSITORY/stackstate/stackstate-agent-runner-circle:$BASE_RUNNER_IMAGE_VERSION .
    - docker push $DOCKER_REPOSITORY/stackstate/stackstate-agent-runner-circle:$BASE_RUNNER_IMAGE_VERSION
    - echo Produced deb based container version $BASE_RUNNER_IMAGE_VERSION
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

#  image: artifactory.stackstate.io/docker-virtual/stackstate/stackstate-agent-runner-gitlab:deb7_{yyyymmdd}
build-main-runner:
  <<: *docker_build_base
  stage: build_runners
  needs: [build-deb-base]
  script:
    - cd RUNNER7_MAIN
    # get the current date as the base image version
    - BASE_RUNNER_IMAGE_VERSION="deb7_$(date +%Y%m%d)"
    - echo Using deb base container version $BASE_RUNNER_IMAGE_VERSION
    # make the image, try running sh, push the tag to quay, write the version as a artifact
    - docker build --build-arg BASE_RUNNER_IMAGE_VERSION=$BASE_RUNNER_IMAGE_VERSION -t $DOCKER_REPOSITORY/stackstate/stackstate-agent-runner-gitlab:$BASE_RUNNER_IMAGE_VERSION .
    - docker push $DOCKER_REPOSITORY/stackstate/stackstate-agent-runner-gitlab:$BASE_RUNNER_IMAGE_VERSION
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

#  image: artifactory.stackstate.io/docker-virtual/stackstate/stackstate-agent-runner-gitlab:centos7_20211004_v7_0

#  image: artifactory.stackstate.io/docker-virtual/stackstate/stackstate-agent-runner-gitlab:centos6_20190429

#  image: artifactory.stackstate.io/docker-virtual/stackstate/stackstate-agent-runner-gitlab:deb-rpmpublisher
