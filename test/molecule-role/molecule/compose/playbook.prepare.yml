---
- name: Create
  hosts: localhost
  connection: local
  gather_facts: true
  tasks:
    - include_tasks: ../common/prepare/copy-molecule-cache.yml

- name: Create
  hosts: localhost
  connection: local
  gather_facts: true
  vars:
    ssh_port: 22
    security_group_name: molecule_compose
    security_group_description: Agent v2 Molecule testing running on docker compose
    security_group_rules:
      - proto: tcp
        from_port: "{{ ssh_port }}"
        to_port: "{{ ssh_port }}"
        cidr_ip: '0.0.0.0/0'
      - proto: tcp
        from_port: 7070
        to_port: 7070
        cidr_ip: '0.0.0.0/0'
      - proto: icmp
        from_port: 8
        to_port: -1
        cidr_ip: '0.0.0.0/0'
    security_group_rules_egress:
      - proto: -1
        from_port: 0
        to_port: 0
        cidr_ip: '0.0.0.0/0'
  tasks:
    - include_tasks: ../common/create/create-structure.yml
    - include_tasks: ../common/create/create-security-group.yml
    - include_tasks: ../common/create/keypair.yml
    - include_tasks: ../common/create/create-molecule-instances.yml
    - include_tasks: ../common/create/wait-for-instance-creation-to-complete.yml
    - include_tasks: ../common/create/wait-for-ssh.yml
    - include_tasks: ../common/create/copy-molecule-cache.yml

- name: Prepare Trace Java
  hosts: trace-java-demo
  gather_facts: true
  tasks:
    - include_tasks: ../common/prepare/ubuntu18-automatic-updates.yml
    - include_tasks: ../common/prepare/install-provisioning-dependencies.yml
    - include_tasks: ../common/prepare/docker-login.yml
    - include_tasks: ../common/prepare/copy-configuration-files.yml
    - include_tasks: ../common/prepare/copy-verify-and-create-script-file.yml
    - include_tasks: ../common/prepare/gather-facts.yml
    - name: Configure .env file used by docker-compose
      copy:
        content: |
          AGENT_DOCKER_REPO={{ agent_docker_repo }}
          AGENT_VERSION={{ agent_current_branch }}
          DOCKER_HOST_IP={{ ansible_docker0['ipv4']['address'] }}
          STACKSTATE_BRANCH={{ stackstate_branch }}
        dest: /home/ubuntu/.env

# - include_tasks: ../common/prepare/docker-compose-pull.yml
# - name: Prepare Connection
#   hosts: localhost
#   connection: local
#   gather_facts: true
#   tasks:
#     - include_tasks: ../common/prepare/encrypt-key.yml
