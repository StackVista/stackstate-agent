include:
  - '/.gitlab-ci-agent.yml'
  - '/.gitlab-ci-build-runners.yml'
  - '/.gitlab-ci-beest.yml'

stages:
  - optional_builds
  - acceptance_create_infra
  - build_dependencies
  - build
  - build_test
  - pre_release_agent
  - acceptance_tests_general
  - acceptance_tests_receiver
  - acceptance_tests_optional_qa_sts
  - acceptance_cleanup_success_infra
  - acceptance_cleanup_failed_infra
  - release_agent


image: artifactory.tooling.stackstate.io/docker-virtual/stackstate/stackstate-agent-runner-gitlab:debian-20220505

variables:
  # Beest
  RUNNER_BEEST_BASE: $CI_PROJECT_DIR/.ci-builders/beest-base

  # Gitlab CI Builers
  BUILDERS_FOLDER: $CI_PROJECT_DIR/.ci-builders
  RUNNER_DEBIAN_BASE: debian-base
  RUNNER_DEBIAN: debian
  RUNNER_DEBIAN_RPM_PUBLISHER: debian-rpmpublisher
  RUNNER_CENTOS6_BASE: centos6-base
  RUNNER_CENTOS7_BASE: centos7-base
  RUNNER_CENTOS7: centos7
  DOCKER_REGISTRY: docker.io
  QUAY_REGISTRY: quay.io
  DOCKER_DRIVER: overlay
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""

  # Common Variables
  # The SRC_PATH is in the GOPATH of the builders which
  # currently is /go
  SRC_PATH: /go/src/github.com/StackVista/stackstate-agent
  # Directory in which we execute the omnibus build.
  # For an unknown reason, it does not go well with
  # a ruby dependency if we build directly into $CI_PROJECT_DIR/.omnibus
  OMNIBUS_BASE_DIR: /.omnibus
  OMNIBUS_BASE_DIR_WIN: c:/omnibus-ruby #\$CI_RUNNER_ID
  # Directory in which we execute the omnibus build for SUSE
  # as we want to separate the RPM built for this distro.
  BCC_VERSION: v0.12.0
  SYSTEM_PROBE_GO_VERSION: 1.13.11
  DATADOG_AGENT_EMBEDDED_PATH: /opt/datadog-agent/embedded
  ARCH: amd64
  VCINSTALLDIR: "C:\\Program Files (x86)\\Microsoft Visual Studio\\2017\\Community"
  MOLECULE_K8S_CLUSTER: eks_test_cluster_1_21
  # This variable represents which one of the gitlab pipelines will contain most of the jobs that's not required for both pipelines to run.
  # IE VMS is a massive jobs and only has to run on either v2 or the v3 pipeline. With this variable you can control on which of the pipelines
  # do jobs like these run on
  PROCESS_AGENT_TEST_REPO: stackstate-process-agent-test
  AGENT_HELM_CHART_VERSION: ""
  STACKSTATE_HELM_CHART_VERSION: ""

  # Agent Variables
  CONDA_ENV: ddpy3
  PYTHON_RUNTIMES: '3'
  MAJOR_VERSION: '3'
  STS_VER: 'v3'
  STS_AWS_RELEASE_BUCKET: stackstate-agent-3
  STS_AWS_TEST_BUCKET: stackstate-agent-3-test
  STS_AWS_RELEASE_BUCKET_YUM: stackstate-agent-3-rpm
  STS_AWS_TEST_BUCKET_YUM: stackstate-agent-3-rpm-test
  STS_AWS_RELEASE_BUCKET_WIN: stackstate-agent-3
  STS_AWS_TEST_BUCKET_WIN: stackstate-agent-3-test
  STS_DOCKER_RELEASE_REPO: stackstate-agent
  STS_DOCKER_TEST_REPO: stackstate-agent-test
  STS_DOCKER_RELEASE_REPO_TRACE: stackstate-trace-agent
  STS_DOCKER_TEST_REPO_TRACE: stackstate-trace-agent-test
  STS_DOCKER_RELEASE_REPO_CLUSTER: stackstate-cluster-agent
  STS_DOCKER_TEST_REPO_CLUSTER: stackstate-cluster-agent-test

# build_beest_runners:
#   stage: triggers
#   trigger:
#     include: .gitlab-ci-beest.yml
#     strategy: depend
#   rules:
#     - if: $CI_MERGE_REQUEST_IID
#     - if: $CI_OPEN_MERGE_REQUESTS
#       when: never
#     - if: $CI_COMMIT_BRANCH
